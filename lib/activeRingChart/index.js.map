{"version":3,"file":"index.js","sources":["../../src/components/activeRingChart/index.js"],"sourcesContent":["import React, { useRef, useState, useEffect, useMemo } from 'react'\r\n\r\nimport PropTypes from 'prop-types'\r\n\r\nimport classnames from 'classnames'\r\n\r\nimport Charts from '@jiaminghi/charts'\r\n\r\nimport DvDigitalFlop from '../digitalFlop'\r\n\r\nimport { deepMerge } from '@jiaminghi/charts/lib/util/index'\r\n\r\nimport { deepClone } from '@jiaminghi/c-render/lib/plugin/util'\r\n\r\nimport './style.less'\r\n\r\nconst defaultConfig = {\r\n  /**\r\n   * @description Ring radius\r\n   * @type {String|Number}\r\n   * @default radius = '50%'\r\n   * @example radius = '50%' | 100\r\n   */\r\n  radius: '50%',\r\n  /**\r\n   * @description Active ring radius\r\n   * @type {String|Number}\r\n   * @default activeRadius = '55%'\r\n   * @example activeRadius = '55%' | 110\r\n   */\r\n  activeRadius: '55%',\r\n  /**\r\n   * @description Ring data\r\n   * @type {Array<Object>}\r\n   * @default data = [{ name: '', value: 0 }]\r\n   */\r\n  data: [{ name: '', value: 0 }],\r\n  /**\r\n   * @description Ring line width\r\n   * @type {Number}\r\n   * @default lineWidth = 20\r\n   */\r\n  lineWidth: 20,\r\n  /**\r\n   * @description Active time gap (ms)\r\n   * @type {Number}\r\n   * @default activeTimeGap = 3000\r\n   */\r\n  activeTimeGap: 3000,\r\n  /**\r\n   * @description Ring color (hex|rgb|rgba|color keywords)\r\n   * @type {Array<String>}\r\n   * @default color = [Charts Default Color]\r\n   * @example color = ['#000', 'rgb(0, 0, 0)', 'rgba(0, 0, 0, 1)', 'red']\r\n   */\r\n  color: [],\r\n  /**\r\n   * @description Digital flop style\r\n   * @type {Object}\r\n   */\r\n  digitalFlopStyle: {\r\n    fontSize: 25,\r\n    fill: '#fff'\r\n  },\r\n  /**\r\n   * @description CRender animationCurve\r\n   * @type {String}\r\n   * @default animationCurve = 'easeOutCubic'\r\n   */\r\n  animationCurve: 'easeOutCubic',\r\n  /**\r\n   * @description CRender animationFrame\r\n   * @type {String}\r\n   * @default animationFrame = 50\r\n   */\r\n  animationFrame: 50\r\n}\r\n\r\nconst ActiveRingChart = ({ config = {}, className, style }) => {\r\n  const [{ activeIndex, mergedConfig }, setState] = useState({\r\n    activeIndex: 0,\r\n    mergedConfig: null\r\n  })\r\n\r\n  const domRef = useRef(null)\r\n  const chartRef = useRef(null)\r\n  const timerRef = useRef(null)\r\n\r\n  const digitalFlop = useMemo(() => {\r\n    if (!mergedConfig) return {}\r\n\r\n    const { digitalFlopStyle, data } = mergedConfig\r\n\r\n    const value = data.map(({ value }) => value)\r\n\r\n    const sum = value.reduce((all, v) => all + v, 0)\r\n\r\n    const percent = parseInt((value[activeIndex] / sum) * 100)\r\n\r\n    return { content: '{nt}%', number: [percent], style: digitalFlopStyle }\r\n  }, [mergedConfig, activeIndex])\r\n\r\n  const ringName = useMemo(\r\n    () => (!mergedConfig ? '' : mergedConfig.data[activeIndex].name),\r\n    [mergedConfig, activeIndex]\r\n  )\r\n\r\n  const fontSize = useMemo(\r\n    () =>\r\n      !mergedConfig\r\n        ? {}\r\n        : { fontSize: `${mergedConfig.digitalFlopStyle.fontSize}px` },\r\n    [mergedConfig]\r\n  )\r\n\r\n  function getRingOption(mergedConfig) {\r\n    const radius = getRealRadius(mergedConfig)\r\n\r\n    const newMergedConfig = {\r\n      ...mergedConfig,\r\n      data: mergedConfig.data.map(item => ({ ...item, radius }))\r\n    }\r\n\r\n    return {\r\n      series: [\r\n        {\r\n          type: 'pie',\r\n          ...newMergedConfig,\r\n          outsideLabel: {\r\n            show: false\r\n          }\r\n        }\r\n      ],\r\n      color: newMergedConfig.color\r\n    }\r\n  }\r\n\r\n  function getRealRadius({ radius, activeRadius, lineWidth }, active = false) {\r\n    const maxRadius = Math.min(...chartRef.current.render.area) / 2\r\n\r\n    const halfLineWidth = lineWidth / 2\r\n\r\n    let realRadius = active ? activeRadius : radius\r\n\r\n    if (typeof realRadius !== 'number') {\r\n      realRadius = (parseInt(realRadius) / 100) * maxRadius\r\n    }\r\n\r\n    const insideRadius = realRadius - halfLineWidth\r\n    const outSideRadius = realRadius + halfLineWidth\r\n\r\n    return [insideRadius, outSideRadius]\r\n  }\r\n\r\n  function ringAnimation() {\r\n    const radius = getRealRadius(mergedConfig)\r\n    const active = getRealRadius(mergedConfig, true)\r\n\r\n    const option = getRingOption(mergedConfig)\r\n\r\n    const data = option.series[0].data.map((item, i) => ({\r\n      ...item,\r\n      radius: i === activeIndex ? active : radius\r\n    }))\r\n\r\n    chartRef.current.setOption(option)\r\n\r\n    const { activeTimeGap } = option.series[0]\r\n\r\n    timerRef.current = setTimeout(foo => {\r\n      let newActiveIndex = activeIndex + 1\r\n\r\n      if (newActiveIndex >= data.length) {\r\n        newActiveIndex = 0\r\n      }\r\n\r\n      setState(state => ({ ...state, activeIndex: newActiveIndex }))\r\n    }, activeTimeGap)\r\n  }\r\n\r\n  useEffect(() => {\r\n    // 第一次时初始化\r\n    chartRef.current || (chartRef.current = new Charts(domRef.current))\r\n\r\n    const mergedConfig = deepMerge(deepClone(defaultConfig, true), config || {})\r\n\r\n    chartRef.current.setOption(getRingOption(mergedConfig))\r\n\r\n    setState({ mergedConfig, activeIndex: 0 })\r\n\r\n    return () => clearTimeout(timerRef.current)\r\n  }, [config])\r\n\r\n  useEffect(ringAnimation, [activeIndex, mergedConfig])\r\n\r\n  const classNames = useMemo(\r\n    () => classnames('dv-active-ring-chart', className),\r\n    className\r\n  )\r\n\r\n  return (\r\n    <div className={classNames} style={style}>\r\n      <div className='active-ring-chart-container' ref={domRef} />\r\n      <div className='active-ring-info'>\r\n        <DvDigitalFlop config={digitalFlop} />\r\n        <div className='active-ring-name' style={fontSize}>\r\n          {ringName}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nActiveRingChart.propTypes = {\r\n  config: PropTypes.object,\r\n  className: PropTypes.string,\r\n  style: PropTypes.object\r\n}\r\n\r\n// 指定 props 的默认值：\r\nActiveRingChart.defaultProps = {\r\n  config: {}\r\n}\r\n\r\nexport default ActiveRingChart\r\n"],"names":["defaultConfig","name","value","ActiveRingChart","config","className","style","useState","activeIndex","mergedConfig","setState","domRef","useRef","chartRef","timerRef","digitalFlop","useMemo","digitalFlopStyle","data","map","sum","reduce","all","v","percent","parseInt","content","number","ringName","fontSize","getRingOption","radius","getRealRadius","newMergedConfig","item","color","activeRadius","lineWidth","active","maxRadius","Math","min","current","render","area","halfLineWidth","realRadius","insideRadius","outSideRadius","ringAnimation","option","series","i","setOption","activeTimeGap","setTimeout","newActiveIndex","length","state","Charts","deepMerge","deepClone","clearTimeout","classNames","classnames","React","DvDigitalFlop","propTypes","PropTypes","object","string","defaultProps"],"mappings":"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"}