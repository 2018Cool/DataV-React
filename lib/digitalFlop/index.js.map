{"version":3,"file":"index.js","sources":["../../src/components/digitalFlop/index.js"],"sourcesContent":["import React, { useEffect, useRef, useMemo } from 'react'\r\n\r\nimport PropTypes from 'prop-types'\r\n\r\nimport classnames from 'classnames'\r\n\r\nimport CRender from '@jiaminghi/c-render'\r\n\r\nimport '@jiaminghi/charts/lib/extend/index'\r\n\r\nimport { deepMerge } from '@jiaminghi/charts/lib/util/index'\r\n\r\nimport { deepClone } from '@jiaminghi/c-render/lib/plugin/util'\r\n\r\nimport './style.less'\r\n\r\nconst defaultConfig = {\r\n  /**\r\n   * @description Number for digital flop\r\n   * @type {Array<Number>}\r\n   * @default number = []\r\n   * @example number = [10]\r\n   */\r\n  number: [],\r\n  /**\r\n   * @description Content formatter\r\n   * @type {String}\r\n   * @default content = ''\r\n   * @example content = '{nt}个'\r\n   */\r\n  content: '',\r\n  /**\r\n   * @description Number toFixed\r\n   * @type {Number}\r\n   * @default toFixed = 0\r\n   */\r\n  toFixed: 0,\r\n  /**\r\n   * @description Text align\r\n   * @type {String}\r\n   * @default textAlign = 'center'\r\n   * @example textAlign = 'center' | 'left' | 'right'\r\n   */\r\n  textAlign: 'center',\r\n  /**\r\n   * @description Text style configuration\r\n   * @type {Object} {CRender Class Style}\r\n   */\r\n  style: {\r\n    fontSize: 30,\r\n    fill: '#3de7c9'\r\n  },\r\n  /**\r\n   * @description CRender animationCurve\r\n   * @type {String}\r\n   * @default animationCurve = 'easeOutCubic'\r\n   */\r\n  animationCurve: 'easeOutCubic',\r\n  /**\r\n   * @description CRender animationFrame\r\n   * @type {String}\r\n   * @default animationFrame = 50\r\n   */\r\n  animationFrame: 50\r\n}\r\n\r\nconst DigitalFlop = ({ config = {}, className, style }) => {\r\n  const domRef = useRef(null)\r\n  const rendererRef = useRef(null)\r\n  const graphRef = useRef(null)\r\n\r\n  const mergedConfigRef = useRef(null)\r\n\r\n  const mountedRef = useRef(true)\r\n\r\n  function init() {\r\n    rendererRef.current = new CRender(domRef.current)\r\n\r\n    mergedConfigRef.current = getMergedConfig()\r\n\r\n    graphRef.current = getGraph()\r\n  }\r\n\r\n  const getMergedConfig = () =>\r\n    deepMerge(deepClone(defaultConfig, true), config || {})\r\n\r\n  function getGraph() {\r\n    const { animationCurve, animationFrame } = mergedConfigRef.current\r\n\r\n    return rendererRef.current.add({\r\n      name: 'numberText',\r\n      animationCurve,\r\n      animationFrame,\r\n      shape: getShape(),\r\n      style: getStyle()\r\n    })\r\n  }\r\n\r\n  function getShape() {\r\n    const { number, content, toFixed, textAlign } = mergedConfigRef.current\r\n    const [w, h] = rendererRef.current.area\r\n\r\n    const position = [w / 2, h / 2]\r\n\r\n    if (textAlign === 'left') position[0] = 0\r\n    if (textAlign === 'right') position[0] = w\r\n\r\n    return { number, content, toFixed, position }\r\n  }\r\n\r\n  function getStyle() {\r\n    const { style, textAlign } = mergedConfigRef.current\r\n\r\n    return deepMerge(style, {\r\n      textAlign,\r\n      textBaseline: 'middle'\r\n    })\r\n  }\r\n\r\n  useEffect(init, [])\r\n\r\n  function update() {\r\n    const mergedConfig = (mergedConfigRef.current = getMergedConfig())\r\n    const graph = graphRef.current\r\n\r\n    const shape = getShape()\r\n\r\n    const cacheNum = graph.shape.number.length\r\n    const shapeNum = shape.number.length\r\n\r\n    cacheNum !== shapeNum && (graph.shape.number = shape.number)\r\n\r\n    const { animationCurve, animationFrame } = mergedConfig\r\n\r\n    Object.assign(graph, { animationCurve, animationFrame })\r\n\r\n    graph.animation('style', getStyle(), true)\r\n    graph.animation('shape', shape)\r\n  }\r\n\r\n  useEffect(() => {\r\n    !mountedRef.current && update()\r\n\r\n    return () => {\r\n      mountedRef.current = false\r\n    }\r\n  }, [config])\r\n\r\n  const classNames = useMemo(() => classnames('dv-digital-flop', className), [\r\n    className\r\n  ])\r\n\r\n  return (\r\n    <div className={classNames} style={style}>\r\n      <canvas ref={domRef} />\r\n    </div>\r\n  )\r\n}\r\n\r\nDigitalFlop.propTypes = {\r\n  config: PropTypes.object,\r\n  className: PropTypes.string,\r\n  style: PropTypes.object\r\n}\r\n\r\n// 指定 props 的默认值：\r\nDigitalFlop.defaultProps = {\r\n  config: {}\r\n}\r\n\r\nexport default DigitalFlop\r\n"],"names":["defaultConfig","DigitalFlop","config","className","style","domRef","useRef","rendererRef","graphRef","mergedConfigRef","mountedRef","init","current","CRender","getMergedConfig","getGraph","deepMerge","deepClone","animationCurve","animationFrame","add","getShape","getStyle","number","content","toFixed","textAlign","area","w","h","position","update","mergedConfig","graph","shape","cacheNum","length","shapeNum","assign","animation","classNames","useMemo","classnames","React","propTypes","PropTypes","object","string","defaultProps"],"mappings":"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"}