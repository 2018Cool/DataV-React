{"version":3,"file":"index.js","sources":["../../src/components/scrollRankingBoard/index.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react'\r\n\r\nimport PropTypes from 'prop-types'\r\n\r\nimport { deepMerge } from '@jiaminghi/charts/lib/util/index'\r\n\r\nimport { deepClone } from '@jiaminghi/c-render/lib/plugin/util'\r\n\r\nimport useAutoResize from '../../use/autoResize'\r\n\r\nimport './style.less'\r\n\r\nconst defaultConfig = {\r\n  /**\r\n   * @description Board data\r\n   * @type {Array<Object>}\r\n   * @default data = []\r\n   */\r\n  data: [],\r\n  /**\r\n   * @description Row num\r\n   * @type {Number}\r\n   * @default rowNum = 5\r\n   */\r\n  rowNum: 5,\r\n  /**\r\n   * @description Scroll wait time\r\n   * @type {Number}\r\n   * @default waitTime = 2000\r\n   */\r\n  waitTime: 2000,\r\n  /**\r\n   * @description Carousel type\r\n   * @type {String}\r\n   * @default carousel = 'single'\r\n   * @example carousel = 'single' | 'page'\r\n   */\r\n  carousel: 'single',\r\n  /**\r\n   * @description Value unit\r\n   * @type {String}\r\n   * @default unit = ''\r\n   * @example unit = 'ton'\r\n   */\r\n  unit: ''\r\n}\r\n\r\nfunction calcRowsData({ data, rowNum }) {\r\n  data.sort(({ value: a }, { value: b }) => {\r\n    if (a > b) return -1\r\n    if (a < b) return 1\r\n    if (a === b) return 0\r\n  })\r\n\r\n  const value = data.map(({ value }) => value)\r\n\r\n  const max = Math.max(...value) || 0\r\n\r\n  data = data.map((row, i) => ({\r\n    ...row,\r\n    ranking: i + 1,\r\n    percent: (row.value / max) * 100\r\n  }))\r\n\r\n  const rowLength = data.length\r\n\r\n  if (rowLength > rowNum && rowLength < 2 * rowNum) {\r\n    data = [...data, ...data]\r\n  }\r\n\r\n  data = data.map((d, i) => ({ ...d, scroll: i }))\r\n\r\n  return data\r\n}\r\n\r\nconst ScrollRankingBoard = ({ config }) => {\r\n  const { height, domRef } = useAutoResize(calcData, onResize)\r\n\r\n  const [state, setState] = useState({\r\n    mergedConfig: null,\r\n\r\n    rowsData: [],\r\n\r\n    rows: [],\r\n\r\n    avgHeight: 0,\r\n\r\n    heights: [],\r\n\r\n    animationIndex: 0\r\n  })\r\n\r\n  const { mergedConfig, rows, heights } = state\r\n\r\n  const timerRef = useRef(null)\r\n  const stateRef = useRef(state)\r\n\r\n  stateRef.current = state\r\n\r\n  function onResize() {\r\n    if (!mergedConfig) return\r\n\r\n    calcHeights(true)\r\n  }\r\n\r\n  function calcData() {\r\n    const mergedConfig = deepMerge(deepClone(defaultConfig, true), config || {})\r\n\r\n    const rowsData = calcRowsData(mergedConfig)\r\n\r\n    const heightData = calcHeights(mergedConfig)\r\n\r\n    setState(state => ({\r\n      ...state,\r\n      mergedConfig,\r\n      rowsData,\r\n      rows: [...rowsData],\r\n      ...heightData\r\n    }))\r\n\r\n    animation(true)\r\n  }\r\n\r\n  function calcHeights({ rowNum, data }, onresize = false) {\r\n    const avgHeight = height / rowNum\r\n\r\n    if (onresize) {\r\n      return { avgHeight }\r\n    }\r\n\r\n    return { avgHeight, heights: new Array(data.length).fill(avgHeight) }\r\n  }\r\n\r\n  async function animation(start = false) {\r\n    let {\r\n      avgHeight,\r\n      animationIndex,\r\n      mergedConfig,\r\n      rowsData,\r\n      animation\r\n    } = stateRef.current\r\n\r\n    const { waitTime, carousel, rowNum } = mergedConfig\r\n\r\n    const rowLength = rowsData.length\r\n\r\n    if (rowNum >= rowLength) return\r\n\r\n    if (start) await new Promise(resolve => setTimeout(resolve, waitTime))\r\n\r\n    const animationNum = carousel === 'single' ? 1 : rowNum\r\n\r\n    let rows = rowsData.slice(animationIndex)\r\n    rows.push(...rowsData.slice(0, animationIndex))\r\n\r\n    setState(state => ({\r\n      ...state,\r\n      rows,\r\n      heights: new Array(rowLength).fill(avgHeight)\r\n    }))\r\n\r\n    await new Promise(resolve => setTimeout(resolve, 300))\r\n\r\n    animationIndex += animationNum\r\n\r\n    const back = animationIndex - rowLength\r\n    if (back >= 0) animationIndex = back\r\n\r\n    setState(state => ({\r\n      ...state,\r\n      animationIndex,\r\n      heights: [...state.heights].splice(\r\n        0,\r\n        animationNum,\r\n        ...new Array(animationNum).fill(0)\r\n      )\r\n    }))\r\n\r\n    timerRef.current = setTimeout(animation, waitTime - 300)\r\n  }\r\n\r\n  useEffect(() => {\r\n    calcData()\r\n\r\n    return () => clearTimeout(timerRef.current)\r\n  }, [config])\r\n\r\n  return (\r\n    <div className='dv-scroll-ranking-board' ref={domRef}>\r\n      {rows.map((item, i) => (\r\n        <div\r\n          className='row-item'\r\n          key={item.toString() + item.scroll}\r\n          style={`height: ${heights[i]}px;`}\r\n        >\r\n          <div className='ranking-info'>\r\n            <div className='rank'>No.{item.ranking}</div>\r\n            <div className='info-name'>{item.name}</div>\r\n            <div className='ranking-value'>\r\n              {item.value + mergedConfig.unit}\r\n            </div>\r\n          </div>\r\n\r\n          <div className='ranking-column'>\r\n            <div className='inside-column' style={`width: ${item.percent}%;`}>\r\n              <div className='shine' />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  )\r\n}\r\n\r\nScrollRankingBoard.propTypes = {\r\n  config: PropTypes.object\r\n}\r\n\r\n// 指定 props 的默认值：\r\nScrollRankingBoard.defaultProps = {\r\n  config: {}\r\n}\r\n\r\nexport default ScrollRankingBoard\r\n"],"names":["defaultConfig","calcRowsData","data","rowNum","sort","a","value","b","map","max","Math","row","i","rowLength","length","d","scroll","ScrollRankingBoard","start","stateRef","current","avgHeight","animationIndex","mergedConfig","rowsData","animation","waitTime","carousel","Promise","setTimeout","resolve","slice","push","state","Array","fill","animationNum","back","heights","splice","config","useAutoResize","calcData","onResize","height","domRef","useState","setState","rows","timerRef","useRef","deepMerge","deepClone","heightData","calcHeights","onresize","clearTimeout","item","toString","ranking","name","unit","percent","propTypes","PropTypes","object","defaultProps"],"mappings":"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"}